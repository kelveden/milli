/*! milli 2014-04-12 */
!function(){function a(a){function b(a,b,c){a.respondWith.status=b,this.entity=function(b,c){return a.respondWith.body=b,a.respondWith.contentType=c,this},this.body=function(b){return a.respondWith.body=b,!a.respondWith.contentType&&c&&(a.respondWith.contentType=c),this},this.contentType=function(b){return a.respondWith.contentType=b,this},this.header=function(b,c){return a.respondWith.headers=a.respondWith.headers||{},a.respondWith.headers[b]=c,this},this.times=function(b){return a.times=b,this},this.afterWaiting=function(b){return a.respondWith.wait=b,this},this.vanilliRequestBody=a}function c(a,c,d,e){this.entity=function(a,b){return f.criteria.body=a,f.criteria.contentType=b,this},this.body=function(a){return f.criteria.body=a,!f.criteria.contentType&&d&&(f.criteria.contentType=d),this},this.contentType=function(a){return f.criteria.contentType=a,this},this.header=function(a,b){return f.criteria.headers=f.criteria.headers||{},f.criteria.headers[a]=b,this},this.param=function(a,b){return f.criteria.query=f.criteria.query||{},f.criteria.query[a]=b,this},this.respondWith=function(a){return new b(f,a,e)},this.capture=function(a){return f.capture=a,this};var f={criteria:{method:a},respondWith:{}};f.criteria.url=c}function d(){function a(){return l?l():{promise:null}}function d(a,b,c){if(a)a(c);else{if(!l)throw new Error("No 'done' callback was specified nor a deferrer in the configuration.");b.resolve(c)}}function e(a,b,c){if(a)a(c);else{if(!l)throw new Error("No 'done' callback was specified nor a deferrer in the configuration.");b.reject(c)}}function f(a,b){k.open("POST","http://localhost:"+j+"/_vanilli/stubs",!0),k.onreadystatechange=function(){4===k.readyState&&(200===k.status?b():b(400===k.status?new Error("One or more stubs were invalid. "+k.responseText):new Error("Could not add stubs. "+k.responseText)))},k.setRequestHeader("Content-Type","application/json"),k.send(JSON.stringify(a))}function g(b){var c=a();return k.open("DELETE","http://localhost:"+j+"/_vanilli/stubs",!0),k.onreadystatechange=function(){4===k.readyState&&(200===k.status?d(b,c):e(b,c,new Error("Could not clear stubs. "+k.responseText)))},k.send(),c.promise}function h(b){var c=a();return k.open("GET","http://localhost:"+j+"/_vanilli/stubs/verification",!0),k.onreadystatechange=function(){if(4===k.readyState)if(200===k.status){var a=JSON.parse(k.responseText);0===a.errors.length?d(b,c):e(b,c,new Error("Vanilli expectations were not met:\n\n"+a.errors.join("\n")))}else e(b,c,new Error("Could not verify expectations. "+k.responseText))},k.send(),c.promise}function i(b,c){var f=a();return k.open("GET","http://localhost:"+j+"/_vanilli/captures/"+b,!0),k.onreadystatechange=function(){4===k.readyState&&(200===k.status?d(c,f,JSON.parse(k.responseText)):e(c,f,new Error("Capture could not be found. "+k.responseText)))},k.send(),f.promise}var j,k,l,m=[],n=this;n.apis={},n.configure=function(a){if(!a)throw new Error("Config must be specified.");if(!a.port)throw new Error("config.port must be specified.");j=a.port,k=new XMLHttpRequest,l=a.deferrer},n.stub=function(){function a(a){if(a instanceof c)throw new Error("Stub "+JSON.stringify(a)+" is incomplete - make sure you use a call to 'respondWith' to complete the stub.");if(!(a instanceof b))throw new Error("Argument "+JSON.stringify(a)+" is not a stub - it is a "+typeof a+".");m.push(a)}if(0===arguments.length)throw new Error("Stub content must be specified.");for(var d=0;d<arguments.length;d++)a(arguments[d]);return n},n.expect=function(){n.stub.apply(n,arguments);for(var a=0;a<arguments.length;a++){var b=arguments[a];b.vanilliRequestBody.times||0===b.vanilliRequestBody.times||(b.vanilliRequestBody.times=1),b.vanilliRequestBody.expect=!0}return n},n.run=function(a){f(m.map(function(a){return a.vanilliRequestBody}),function(b){if(m.length=0,b instanceof Error)throw b;if(b)throw new Error(b);a(b)})},n.registerApi=function(a,b){if(!a)throw new Error("An API name must be specified.");for(var c in b)if(b.hasOwnProperty(c)){var d=b[c],e=n.apis[a];if("string"!=typeof d&&!d.url)throw new Error("A uri template must be specified for the resource.");e||(e=n.apis[a]={}),e[c]=d}},n.clearStubs=function(a){return a?void g(a):g},n.getCapture=function(a,b){return b?void i(a,b):function(){return i(a)}},n.verifyExpectations=function(a){return a?void h(a):h}}function e(a,b,d){function e(a,b){return a.replace(/:[a-zA-Z][0-9a-zA-Z]+/g,function(a){var c=a.substr(1),d=b[c];if(void 0===d)throw new Error("Could not find substitution for placeholder '"+a+"'.");return g[c]=d,d})}function f(a,b){if(b)for(var c in b)g[c]||a.param(c,b[c])}var g={};if(!b)throw new Error("The stub url must be specified.");var h,i;return"string"!=typeof b?(i=e(b.url,d||{}),h=new c(a,i,b.consumes,b.produces)):(i=e(b,d||{}),h=new c(a,i)),f(h,d),h}a.onGet=function(a,b){return e("GET",a,b)},a.onDelete=function(a,b){return e("DELETE",a,b)},a.onPut=function(a,b){return e("PUT",a,b)},a.onPost=function(a,b){return e("POST",a,b)},a.milli=new d}"object"==typeof exports?(global.XMLHttpRequest=require("xhr2"),a(global)):a(window)}();