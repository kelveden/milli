/*! milli 2013-12-05 */
(function(t){function e(t,e){function n(t){r.respondWith.status=t,this.entity=function(t,e){return r.respondWith.body=t,r.respondWith.contentType=e,this},this.body=function(t){return r.respondWith.body=t,this},this.contentType=function(t){return r.respondWith.contentType=t,this},this.header=function(t,e){return r.respondWith.headers=r.respondWith.headers||{},r.respondWith.headers[t]=e,this},this.times=function(t){return r.times=t,this},this.vanilliRequestBody=r}this.entity=function(t,e){return r.criteria.body=t,r.criteria.contentType=e,this},this.body=function(t){return r.criteria.body=t,this},this.contentType=function(t){return r.criteria.contentType=t,this},this.header=function(t,e){return r.criteria.headers=r.criteria.headers||{},r.criteria.headers[t]=e,this},this.param=function(t,e){return r.criteria.query=r.criteria.query||{},r.criteria.query[t]=e,this},this.respondWith=function(t){return new n(t)};var r={criteria:{url:e,method:t},respondWith:{}}}function n(t,e){s.open("POST","http://localhost:"+o+"/_vanilli/stubs",!0),s.onreadystatechange=function(){4===s.readyState&&(200===s.status?e():400===s.status?e(Error("One or more stubs were invalid. "+s.responseText)):e(Error("Could not add stubs. "+s.responseText)))},s.setRequestHeader("Content-Type","application/json"),s.send(JSON.stringify(t))}function r(t){s.open("DELETE","http://localhost:"+o+"/_vanilli/stubs",!0),s.onreadystatechange=function(){4===s.readyState&&(200===s.status?t():t(Error("Could not clear stubs. "+s.responseText)))},s.send()}function i(t){s.open("GET","http://localhost:"+o+"/_vanilli/stubs/verification",!0),s.onreadystatechange=function(){if(4===s.readyState)if(200===s.status){var e=JSON.parse(s.responseText);e.errors.length>0?t(Error("Vanilli expectations were not met:\n\n"+e.errors.join("\n"))):t()}else t(Error("Could not verify expectations. "+s.responseText))},s.send()}var o,s,u=[];t.Milli=function(t){if(!t)throw Error("Config must be specified.");if(!t.port)throw Error("config.port must be specified.");return o=t.port,s=new XMLHttpRequest,{stub:function(t){if(!t)throw Error("Stub content must be specified.");return t.vanilliRequestBody.times||0===t.vanilliRequestBody.times||(t.vanilliRequestBody.times=1),u.push(t),this},expect:function(t){return t.vanilliRequestBody.expect=!0,this.stub(t)},clearStubs:function(t){r(t)},verifyExpectations:function(t){i(t)},run:function(t){n(u.map(function(t){return t.vanilliRequestBody}),function(e){if(u.length=0,e instanceof Error)throw e;if(e)throw Error(e);t(e)})}}},t.onRequestTo=function(t,n,r){function i(t,e){return t.replace(/:[a-zA-Z][0-9a-zA-Z]+/g,function(t){var n=t.substr(1),r=e[n];if(void 0===r)throw Error("Could not find substitution for placeholder '"+t+"'.");return r})}if(!n)throw Error("The stub url must be specified.");return new e(t,i(n,r||{}))},t.onGetTo=function(e,n){return t.onRequestTo("GET",e,n)},t.onDeleteTo=function(e,n){return t.onRequestTo("DELETE",e,n)},t.onPutTo=function(e,n){return t.onRequestTo("PUT",e,n)},t.onPostTo=function(e,n){return t.onRequestTo("POST",e,n)}})(window.exports?window.exports:window);