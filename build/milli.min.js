/*! milli 2013-12-12 */
(function(t){function e(t,e,r){t.respondWith.status=e,this.entity=function(e,r){return t.respondWith.body=e,t.respondWith.contentType=r,this},this.body=function(e){return t.respondWith.body=e,!t.respondWith.contentType&&r&&(t.respondWith.contentType=r),this},this.contentType=function(e){return t.respondWith.contentType=e,this},this.header=function(e,r){return t.respondWith.headers=t.respondWith.headers||{},t.respondWith.headers[e]=r,this},this.times=function(e){return t.times=e,this},this.vanilliRequestBody=t}function r(t,r,n,i){this.entity=function(t,e){return o.criteria.body=t,o.criteria.contentType=e,this},this.body=function(t){return o.criteria.body=t,!o.criteria.contentType&&n&&(o.criteria.contentType=n),this},this.contentType=function(t){return o.criteria.contentType=t,this},this.header=function(t,e){return o.criteria.headers=o.criteria.headers||{},o.criteria.headers[t]=e,this},this.param=function(t,e){return o.criteria.query=o.criteria.query||{},o.criteria.query[t]=e,this},this.respondWith=function(t){return new e(o,t,i)},this.capture=function(t){return o.capture=t,this};var o={criteria:{method:t},respondWith:{}};o.criteria.url=r}function n(){function t(){return p?p.defer():{promise:null}}function n(t,e,r){if(t)t(r);else{if(!p)throw Error("No 'done' callback was specified nor a promiser in the configuration.");e.resolve(r)}}function i(t,e,r){if(t)t(r);else{if(!p)throw Error("No 'done' callback was specified nor a promiser in the configuration.");e.reject(r)}}function o(t,e){f.open("POST","http://localhost:"+c+"/_vanilli/stubs",!0),f.onreadystatechange=function(){4===f.readyState&&(200===f.status?e():400===f.status?e(Error("One or more stubs were invalid. "+f.responseText)):e(Error("Could not add stubs. "+f.responseText)))},f.setRequestHeader("Content-Type","application/json"),f.send(JSON.stringify(t))}function s(e){var r=t();return f.open("DELETE","http://localhost:"+c+"/_vanilli/stubs",!0),f.onreadystatechange=function(){4===f.readyState&&(200===f.status?n(e,r):i(e,r,Error("Could not clear stubs. "+f.responseText)))},f.send(),r.promise}function u(e){var r=t();return f.open("GET","http://localhost:"+c+"/_vanilli/stubs/verification",!0),f.onreadystatechange=function(){if(4===f.readyState)if(200===f.status){var t=JSON.parse(f.responseText);0===t.errors.length?n(e,r):i(e,r,Error("Vanilli expectations were not met:\n\n"+t.errors.join("\n")))}else i(e,r,Error("Could not verify expectations. "+f.responseText))},f.send(),r.promise}function a(e,r){var o=t();return f.open("GET","http://localhost:"+c+"/_vanilli/captures/"+e,!0),f.onreadystatechange=function(){4===f.readyState&&(200===f.status?n(r,o,JSON.parse(f.responseText)):i(r,o,Error("Capture could not be found. "+f.responseText)))},f.send(),o.promise}var c,f,p,h=[],d=this;d.api={},d.configure=function(t){if(!t)throw Error("Config must be specified.");if(!t.port)throw Error("config.port must be specified.");c=t.port,f=new XMLHttpRequest,p=t.promiser},d.stub=function(){function t(t){if(t instanceof r)throw Error("Stub "+JSON.stringify(t)+" is incomplete - make sure you use a call to 'respondWith' to complete the stub.");if(!(t instanceof e))throw Error("Argument "+JSON.stringify(t)+" is not a stub - it is a "+typeof t+".");t.vanilliRequestBody.times||0===t.vanilliRequestBody.times||(t.vanilliRequestBody.times=1),h.push(t)}if(0===arguments.length)throw Error("Stub content must be specified.");for(var n=0;arguments.length>n;n++)t(arguments[n]);return d},d.expect=function(){d.stub.apply(d,arguments);for(var t=0;arguments.length>t;t++)arguments[t].vanilliRequestBody.expect=!0;return d},d.run=function(t){o(h.map(function(t){return t.vanilliRequestBody}),function(e){if(h.length=0,e instanceof Error)throw e;if(e)throw Error(e);t(e)})},d.registerApi=function(t){for(var e in t)if(t.hasOwnProperty(e)){var r=t[e];if("string"!=typeof r&&!r.url)throw Error("A uri template must be specified for the resource.");d.api[e]=r}},d.clearStubs=function(t){return t?(s(t),void 0):s},d.getCapture=function(t,e){return e?(a(t,e),void 0):function(){return a(t)}},d.verifyExpectations=function(t){return t?(u(t),void 0):u}}t.onRequest=function(t,e,n){function i(t,e){return t.replace(/:[a-zA-Z][0-9a-zA-Z]+/g,function(t){var r=t.substr(1),n=e[r];if(void 0===n)throw Error("Could not find substitution for placeholder '"+t+"'.");return s[r]=n,n})}function o(t,e){if(e)for(var r in e)s[r]||t.param(r,e[r])}var s={};if(!e)throw Error("The stub url must be specified.");var u,a;return"string"!=typeof e?(a=i(e.url,n||{}),u=new r(t,a,e.consumes,e.produces)):(a=i(e,n||{}),u=new r(t,a)),o(u,n),u},t.onGet=function(e,r){return t.onRequest("GET",e,r)},t.onDelete=function(e,r){return t.onRequest("DELETE",e,r)},t.onPut=function(e,r){return t.onRequest("PUT",e,r)},t.onPost=function(e,r){return t.onRequest("POST",e,r)},t.milli=new n})(window.exports?window.exports:window);