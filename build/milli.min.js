/*! milli 2013-12-10 */
(function(t){function e(t,e){function n(t){o.respondWith.status=t,this.entity=function(t,e){return o.respondWith.body=t,o.respondWith.contentType=e,this},this.body=function(t){return o.respondWith.body=t,!o.respondWith.contentType&&i&&(o.respondWith.contentType=i),this},this.contentType=function(t){return o.respondWith.contentType=t,this},this.header=function(t,e){return o.respondWith.headers=o.respondWith.headers||{},o.respondWith.headers[t]=e,this},this.times=function(t){return o.times=t,this},this.vanilliRequestBody=o}this.entity=function(t,e){return o.criteria.body=t,o.criteria.contentType=e,this},this.body=function(t){return o.criteria.body=t,!o.criteria.contentType&&r&&(o.criteria.contentType=r),this},this.contentType=function(t){return o.criteria.contentType=t,this},this.header=function(t,e){return o.criteria.headers=o.criteria.headers||{},o.criteria.headers[t]=e,this},this.param=function(t,e){return o.criteria.query=o.criteria.query||{},o.criteria.query[t]=e,this},this.respondWith=function(t){return new n(t)},this.capture=function(t){return o.capture=t,this};var r,i,o={criteria:{method:t},respondWith:{}};"string"==typeof e?o.criteria.url=e:(o.criteria.url=e.url,r=e.consumes,i=e.produces)}function n(t,e){u.open("POST","http://localhost:"+s+"/_vanilli/stubs",!0),u.onreadystatechange=function(){4===u.readyState&&(200===u.status?e():400===u.status?e(Error("One or more stubs were invalid. "+u.responseText)):e(Error("Could not add stubs. "+u.responseText)))},u.setRequestHeader("Content-Type","application/json"),u.send(JSON.stringify(t))}function r(t){u.open("DELETE","http://localhost:"+s+"/_vanilli/stubs",!0),u.onreadystatechange=function(){4===u.readyState&&(200===u.status?t():t(Error("Could not clear stubs. "+u.responseText)))},u.send()}function i(t){u.open("GET","http://localhost:"+s+"/_vanilli/stubs/verification",!0),u.onreadystatechange=function(){if(4===u.readyState)if(200===u.status){var e=JSON.parse(u.responseText);e.errors.length>0?t(Error("Vanilli expectations were not met:\n\n"+e.errors.join("\n"))):t()}else t(Error("Could not verify expectations. "+u.responseText))},u.send()}function o(t,e){u.open("GET","http://localhost:"+s+"/_vanilli/captures"+t,!0),u.onreadystatechange=function(){4===u.readyState&&(200===u.status?e(JSON.parse(u.responseText)):e(Error("Capture could not be found. "+u.responseText)))},u.send()}var s,u,a=[];t.milli={configure:function(t){if(!t)throw Error("Config must be specified.");if(!t.port)throw Error("config.port must be specified.");s=t.port,u=new XMLHttpRequest},stub:function(){function t(t){t.vanilliRequestBody.times||0===t.vanilliRequestBody.times||(t.vanilliRequestBody.times=1),a.push(t)}if(0===arguments.length)throw Error("Stub content must be specified.");for(var e=0;arguments.length>e;e++)t(arguments[e]);return this},expect:function(t){return t.vanilliRequestBody.expect=!0,this.stub(t)},clearStubs:function(t){r(t)},verifyExpectations:function(t){i(t)},run:function(t){n(a.map(function(t){return t.vanilliRequestBody}),function(e){if(a.length=0,e instanceof Error)throw e;if(e)throw Error(e);t(e)})},registerApi:function(e){for(var n in e)if(e.hasOwnProperty(n)){var r=e[n];if("string"!=typeof r&&!r.url)throw Error("A uri template must be specified for the resource.");t[n]=r}},getCapture:o},t.onRequest=function(t,n,r){function i(t,e){return t.replace(/:[a-zA-Z][0-9a-zA-Z]+/g,function(t){var n=t.substr(1),r=e[n];if(void 0===r)throw Error("Could not find substitution for placeholder '"+t+"'.");return r})}if(!n)throw Error("The stub url must be specified.");return"string"!=typeof n?n.url=i(n.url,r||{}):n=i(n,r||{}),new e(t,n)},t.onGet=function(e,n){return t.onRequest("GET",e,n)},t.onDelete=function(e,n){return t.onRequest("DELETE",e,n)},t.onPut=function(e,n){return t.onRequest("PUT",e,n)},t.onPost=function(e,n){return t.onRequest("POST",e,n)}})(window.exports?window.exports:window);